<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet author="vishnu" id = "create required sql functions">
        <sqlFile path="../sql_files/sql_functions.sql" endDelimiter="\nGO" stripComments="false" relativeToChangelogFile="true"/>
    </changeSet>

    <changeSet author="vishnu" id="add missing eventRecords for patients ">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from patient
                where date_created &lt; (select min(date_created) from event_records where category = 'patient');
            </sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO event_records(uuid,title,timestamp,object,uri,category,tags)
            select uuid(),'Patient',now(),CONCAT('/openmrs/ws/rest/v1/patient/',uuid, '?v=full'),NULL,'patient','patient'
            from person where date_created &lt; (select min(date_created) from event_records where category = 'patient');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add missing eventRecords for programEnrolment">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from patient_program
                where date_created &lt; (select min(date_created) from event_records where category = 'programenrollment');
            </sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO event_records(uuid,title,timestamp,object,uri,category,tags)
            select uuid(),'Progam Enrollment',now(),CONCAT('/openmrs/ws/rest/v1/programenrollment/',uuid, '?v=full'),NULL,'programenrollment','programenrollment'
            from patient_program where date_created &lt; (select min(date_created) from event_records where category = 'programenrollment');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add missing eventRecords for Encounter">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from encounter
                where date_created &lt; (select min(date_created) from event_records where category = 'Encounter');
            </sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO event_records(uuid,title,timestamp,object,uri,category,tags)
            select uuid(),'Encounter',now(),CONCAT('/openmrs/ws/rest/v1/bahmniencounter/',uuid, '?v=full'),NULL,'Encuonter','Encounter'
            from encounter where date_created &lt; (select min(date_created) from event_records where category = 'Encounter');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add concept class for Facility">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from concept_class
                where name = 'Facility';
            </sqlCheck>
        </preConditions>
        <sql>
            insert into concept_class(name, description, creator, date_created, uuid)
            values('Facility', 'Facility field in forms', 1, now(), 'a027ba3d-3f61-4d2e-98d2-5dd0eac357d5');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="set Facility as concept class for all facility concepts">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*)
                from concept_class
                where name = 'Facility';
            </sqlCheck>
        </preConditions>
        <sql>
            update concept c inner join concept_name cn on c.concept_id = cn.concept_id and cn.name = 'Facility'
                set c.class_id = (select concept_class_id from concept_class where name = 'Facility');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add concept class for District">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from concept_class
                where name = 'District';
            </sqlCheck>
        </preConditions>
        <sql>
            insert into concept_class(name, description, creator, date_created, uuid)
            values('District', 'District field in forms', 1, now(), 'e3564a79-84e0-4595-9868-1ba2f2ecda52');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="set District as concept class for all district concepts">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*)
                from concept_class
                where name = 'District';
            </sqlCheck>
        </preConditions>
        <sql>
            update concept c inner join concept_name cn on c.concept_id = cn.concept_id and cn.name = 'District'
                set c.class_id = (select concept_class_id from concept_class where name = 'District');
        </sql>
    </changeSet>

</databaseChangeLog>
